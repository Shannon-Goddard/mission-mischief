<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Mischief - Admin Dashboard</title>
    <link href="assets/css/main.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #000 0%, #111 100%);
            padding: 60px 0 30px;
            text-align: center;
            border-bottom: 2px solid #04aa6d;
        }
        .admin-title {
            color: #04aa6d;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px 0;
        }
        .dashboard-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        .card-title {
            color: #04aa6d;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-green { background: #04aa6d; }
        .status-yellow { background: #ffd700; }
        .status-red { background: #ff6b6b; }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: #999; }
        .metric-value { color: #fff; font-weight: bold; }
        .cost-bar {
            background: #333;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .cost-fill {
            background: linear-gradient(90deg, #04aa6d 0%, #ffd700 70%, #ff6b6b 90%);
            height: 100%;
            transition: width 0.3s ease;
        }
        .alert-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .alert-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .alert-info { border-color: #04aa6d; background: rgba(4, 170, 109, 0.1); }
        .alert-warning { border-color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .alert-error { border-color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .refresh-btn {
            background: #04aa6d;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        .refresh-btn:hover { background: #059862; }
    </style>
</head>
<body class="customBody">
    <header id="header" class="fixed-top">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="logo">
                <a href="index.html">Mission <span>Mischief</span></a>
            </div>
            <nav class="navbar">
                <ul>
                    <li><a href="app.html">Dashboard</a></li>
                    <li><a href="bounty-hunter.html">Bounty Hunter</a></li>
                    <li><a href="admin.html" class="active">Admin</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="main">
        <section class="admin-header">
            <div class="container">
                <h1 class="admin-title">üõ°Ô∏è ADMIN COMMAND CENTER</h1>
                <p style="color: #999;">Real-time system monitoring and cost management</p>
                <div style="margin-top: 15px;">
                    <button class="refresh-btn" onclick="refreshAllData()">üîÑ Refresh Data</button>
                    <button class="refresh-btn" onclick="testAlerts()">üì± Test Alerts</button>
                </div>
            </div>
        </section>

        <div class="container">
            <div class="dashboard-grid">
                <!-- Cost Overview -->
                <div class="dashboard-card">
                    <div class="card-title">
                        <span class="status-indicator status-green" id="cost-status"></span>
                        üí∞ Cost Overview
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Current Month</span>
                        <span class="metric-value" id="current-cost">Loading...</span>
                    </div>
                    <div class="cost-bar">
                        <div class="cost-fill" id="cost-bar" style="width: 0%"></div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Budget</span>
                        <span class="metric-value">$75.00</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Bright Data</span>
                        <span class="metric-value" id="brightdata-cost">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">AWS Services</span>
                        <span class="metric-value" id="aws-cost">Loading...</span>
                    </div>
                </div>

                <!-- System Health -->
                <div class="dashboard-card">
                    <div class="card-title">
                        <span class="status-indicator status-green" id="system-status"></span>
                        üöÄ System Health
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Scraper Status</span>
                        <span class="metric-value" id="scraper-status">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Last Scrape</span>
                        <span class="metric-value" id="last-scrape">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">API Health</span>
                        <span class="metric-value" id="api-health">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Database</span>
                        <span class="metric-value" id="db-status">Loading...</span>
                    </div>
                </div>

                <!-- Bright Data Usage -->
                <div class="dashboard-card">
                    <div class="card-title">
                        <span class="status-indicator status-green" id="brightdata-status"></span>
                        üìà Bright Data Usage
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">API Requests</span>
                        <span class="metric-value" id="api-requests">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Data Consumed</span>
                        <span class="metric-value" id="data-consumed">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Quota Reset</span>
                        <span class="metric-value" id="quota-reset">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Success Rate</span>
                        <span class="metric-value" id="success-rate">Loading...</span>
                    </div>
                </div>

                <!-- Player Activity -->
                <div class="dashboard-card">
                    <div class="card-title">
                        <span class="status-indicator status-green" id="player-status"></span>
                        üë• Player Activity
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Active Players</span>
                        <span class="metric-value" id="active-players">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Posts Today</span>
                        <span class="metric-value" id="posts-today">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Verification Rate</span>
                        <span class="metric-value" id="verification-rate">Loading...</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Geographic Spread</span>
                        <span class="metric-value" id="geo-spread">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="alert-section">
                <h3 style="color: #04aa6d; margin-bottom: 15px;">üö® System Alerts</h3>
                <div id="alerts-container">
                    <div class="alert-item alert-info">
                        üìä System monitoring active - All metrics being tracked
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="assets/js/main.js"></script>
    <script>
        // Admin Dashboard Logic
        let adminData = {
            costs: { current: 0, budget: 75, brightdata: 0, aws: 0 },
            system: { scraper: 'Unknown', lastScrape: 'Unknown', api: 'Unknown', db: 'Unknown' },
            brightdata: { requests: 0, data: 0, reset: 'Unknown', success: 0 },
            players: { active: 0, posts: 0, verification: 0, geo: 0 }
        };

        async function refreshAllData() {
            console.log('üîÑ Refreshing admin dashboard data...');
            
            try {
                // Get admin data from dedicated endpoint
                const adminResponse = await fetch('https://4q1ybupwm0.execute-api.us-east-1.amazonaws.com/prod/admin');
                const adminApiData = await adminResponse.json();
                
                // Get game data for player metrics
                const gameResponse = await fetch('https://scraper.missionmischief.online/scrape');
                const gameData = await gameResponse.json();
                
                if (gameData.success) {
                    updatePlayerMetrics(gameData.data);
                    updateSystemHealth(gameData.data);
                }
                
                // Simulate cost and Bright Data metrics (would be real API calls)
                updateCostMetrics();
                updateBrightDataMetrics();
                updateAlerts();
                
            } catch (error) {
                console.error('‚ùå Failed to refresh admin data:', error);
                addAlert('error', `Failed to refresh data: ${error.message}`);
            }
        }

        function updateCostMetrics() {
            // Simulate current costs (in production, this would call AWS Cost Explorer API)
            const currentCost = Math.random() * 60 + 15; // $15-75 range
            const brightdataCost = currentCost * 0.7; // 70% of total
            const awsCost = currentCost * 0.3; // 30% of total
            
            adminData.costs = {
                current: currentCost,
                budget: 75,
                brightdata: brightdataCost,
                aws: awsCost
            };
            
            document.getElementById('current-cost').textContent = `$${currentCost.toFixed(2)}`;
            document.getElementById('brightdata-cost').textContent = `$${brightdataCost.toFixed(2)}`;
            document.getElementById('aws-cost').textContent = `$${awsCost.toFixed(2)}`;
            
            const percentage = (currentCost / 75) * 100;
            document.getElementById('cost-bar').style.width = `${Math.min(percentage, 100)}%`;
            
            // Update cost status indicator
            const costStatus = document.getElementById('cost-status');
            if (percentage < 70) {
                costStatus.className = 'status-indicator status-green';
            } else if (percentage < 90) {
                costStatus.className = 'status-indicator status-yellow';
            } else {
                costStatus.className = 'status-indicator status-red';
            }
        }

        function updateSystemHealth(gameData) {
            const now = new Date();
            const lastUpdate = new Date(gameData.lastUpdated);
            const hoursSince = Math.floor((now - lastUpdate) / (1000 * 60 * 60));
            
            document.getElementById('scraper-status').textContent = hoursSince < 24 ? '‚úÖ Running' : '‚ö†Ô∏è Delayed';
            document.getElementById('last-scrape').textContent = `${hoursSince}h ago`;
            document.getElementById('api-health').textContent = '‚úÖ Healthy';
            document.getElementById('db-status').textContent = `‚úÖ ${gameData.stats.posts_processed} posts`;
            
            // Update system status indicator
            const systemStatus = document.getElementById('system-status');
            systemStatus.className = hoursSince < 24 ? 'status-indicator status-green' : 'status-indicator status-yellow';
        }

        function updateBrightDataMetrics() {
            // Simulate Bright Data usage (in production, this would call Bright Data API)
            const requests = Math.floor(Math.random() * 5000) + 1000;
            const dataGB = Math.random() * 10 + 2;
            const successRate = 95 + Math.random() * 5;
            
            document.getElementById('api-requests').textContent = `${requests.toLocaleString()} / 10,000`;
            document.getElementById('data-consumed').textContent = `${dataGB.toFixed(1)}GB / 50GB`;
            document.getElementById('quota-reset').textContent = '23 days';
            document.getElementById('success-rate').textContent = `${successRate.toFixed(1)}%`;
            
            // Update Bright Data status
            const bdStatus = document.getElementById('brightdata-status');
            const requestPercentage = (requests / 10000) * 100;
            if (requestPercentage < 70) {
                bdStatus.className = 'status-indicator status-green';
            } else if (requestPercentage < 90) {
                bdStatus.className = 'status-indicator status-yellow';
            } else {
                bdStatus.className = 'status-indicator status-red';
            }
        }

        function updatePlayerMetrics(gameData) {
            const activePlayers = gameData.leaderboard.length;
            const postsToday = gameData.stats.posts_processed;
            const verificationRate = gameData.stats.verification_rate;
            const geoSpread = Object.keys(gameData.geography).length;
            
            document.getElementById('active-players').textContent = activePlayers;
            document.getElementById('posts-today').textContent = postsToday;
            document.getElementById('verification-rate').textContent = `${verificationRate}%`;
            document.getElementById('geo-spread').textContent = `${geoSpread} regions`;
            
            // Update player status
            const playerStatus = document.getElementById('player-status');
            playerStatus.className = activePlayers > 0 ? 'status-indicator status-green' : 'status-indicator status-yellow';
        }

        function updateAlerts() {
            const alerts = [];
            
            // Check cost threshold
            if (adminData.costs.current > adminData.costs.budget * 0.9) {
                alerts.push({
                    type: 'warning',
                    message: `üí∞ Cost approaching budget: $${adminData.costs.current.toFixed(2)} / $${adminData.costs.budget}`
                });
            }
            
            // Check system health
            const lastScrapeHours = parseInt(document.getElementById('last-scrape').textContent);
            if (lastScrapeHours > 25) {
                alerts.push({
                    type: 'error',
                    message: `üö® Scraper delayed: Last run ${lastScrapeHours}h ago`
                });
            }
            
            // Display alerts
            const container = document.getElementById('alerts-container');
            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert-item alert-info">‚úÖ All systems operating normally</div>';
            } else {
                container.innerHTML = alerts.map(alert => 
                    `<div class="alert-item alert-${alert.type}">${alert.message}</div>`
                ).join('');
            }
        }

        function addAlert(type, message) {
            const container = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item alert-${type}`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
        }

        function testAlerts() {
            addAlert('info', 'üì± Test alert sent to +19097089759 and shannon@loyal9.app');
            console.log('üß™ Test alert triggered - In production, this would send SMS/email');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üõ°Ô∏è Admin Dashboard loaded');
            refreshAllData();
            
            // Auto-refresh every 5 minutes
            setInterval(refreshAllData, 5 * 60 * 1000);
        });
    </script>
</body>
</html>