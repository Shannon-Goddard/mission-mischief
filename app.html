<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <!-- Webview Security Headers -->
  <meta name="robots" content="noindex, nofollow, nosnippet">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;">
  
  <!-- Mobile WebView Optimizations -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  
  <title>Mission Mischief - Dashboard</title>
  <meta content="Your Mission Mischief dashboard - track missions, badges, and honor score" name="description">
  
  <!-- Favicons -->
  <link href="assets/images/ui/favicon.png" rel="icon">
  <link href="assets/images/ui/apple-touch-icon.png" rel="apple-touch-icon">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- CSS Files -->
  <link href="assets/css/main.css" rel="stylesheet">
  <link href="assets/css/components.css" rel="stylesheet">
  
  <style>
    /* iPhone Safe Area Support */
    body {
      padding-top: env(safe-area-inset-top);
    }
    
    #header {
      padding-top: calc(15px + env(safe-area-inset-top));
      padding-bottom: 15px;
      min-height: calc(60px + env(safe-area-inset-top));
    }
    
    /* Fix scroll positioning and screen movement */
    html {
      scroll-behavior: auto !important;
      overflow-x: hidden;
    }
    
    body {
      overflow-x: hidden;
      width: 100vw;
      max-width: 100vw;
      position: relative;
    }
    
    #main {
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    
    /* Force dashboard to start at top */
    #dashboard {
      scroll-margin-top: 0 !important;
      scroll-behavior: auto !important;
    }
    
    /* Mobile-First Responsive Design */
    @media (max-width: 768px) {
      .container { 
        padding: 0 15px;
        max-width: 100%;
        overflow-x: hidden;
      }
      
      body {
        overflow-x: hidden;
        width: 100%;
      }
      
      .mission-card { 
        margin-bottom: 15px; 
        font-size: 14px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .mission-btn { 
        padding: 8px 12px; 
        font-size: 12px; 
        margin: 2px; 
        word-wrap: break-word; 
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .mission-actions { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 5px; 
      }
      
      .mission-actions .mission-btn { 
        flex: 1; 
        min-width: 80px; 
        text-align: center; 
      }
      
      .user-stats { 
        flex-wrap: wrap; 
        gap: 10px; 
      }
      
      .stat-card { 
        min-width: calc(50% - 5px); 
      }
      
      .feature-cards { 
        flex-direction: column; 
      }
      
      .buyin-card { 
        margin-bottom: 15px; 
      }
      
      #missionUploadModal { 
        padding: 10px; 
      }
      
      #missionUploadModal > div { 
        max-width: 95vw; 
        padding: 15px; 
      }
      
      /* Fix form input sizing on mobile */
      .form-control {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 8px 12px;
      }
      
      /* Expand form container on mobile */
      .col-lg-6 {
        max-width: 100% !important;
        padding: 0 10px;
      }
      
      /* Header adjustments for mobile */
      .logo a {
        font-size: 20px !important;
      }
      
      .user-info {
        font-size: 12px !important;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }
    
    /* Loading States */
    .loading { opacity: 0.6; pointer-events: none; }
    .loading::after {
      content: '‚è≥';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
    }
  </style>
</head>

<body class="customBody">

  <!-- Header -->
  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="logo">
        <a href="index.html">Mission <span>Mischief</span></a>
      </div>
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="user-info" id="userInfo" style="color: #04aa6d; font-weight: bold;"></div>
        <div id="headerBadge" style="display: none;">
          <a href="bounty-hunter.html" style="display: inline-block;">
            <img src="assets/images/badges/bounty-hunter-badge-color.png" alt="Bounty Hunter" style="width: 32px; height: 32px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="main">
    
    <!-- User Setup Section (shown if no user) -->
    <section id="userSetup" class="section-bg" style="display: none; padding-top: calc(100px + env(safe-area-inset-top));">
      <div class="container">
        <div class="row" style="margin: 0; width: 100%;">
          <div class="col-12" style="padding: 0 20px; width: 100%;">
            <div class="mission-card" style="padding: 30px; width: 100%; max-width: none; margin: 0; box-sizing: border-box;">
              <h2 class="text-center mb-4">Welcome to Mission Mischief!</h2>
              <form id="setupForm">
                <div class="mb-3">
                  <label for="userName" class="form-label">Your Name:</label>
                  <input type="text" id="userName" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label for="userHandle" class="form-label">Social Media Handle:</label>
                  <input type="text" id="userHandle" class="form-control" placeholder="@username" required>
                </div>
                <div class="mb-3">
                  <label for="userCountry" class="form-label">Country:</label>
                  <select id="userCountry" class="form-control" required onchange="loadStates(); toggleCountryOther();">
                    <option value="">Select Country</option>
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="UK">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="OTHER">Other</option>
                  </select>
                  <input type="text" id="userCountryOther" class="form-control" placeholder="Enter country" style="display: none; margin-top: 10px;">
                </div>
                <div class="mb-3">
                  <label for="userState" class="form-label">State/Province:</label>
                  <select id="userState" class="form-control" required onchange="loadCities(); toggleStateOther();" disabled>
                    <option value="">Select State/Province</option>
                  </select>
                  <input type="text" id="userStateOther" class="form-control" placeholder="Enter state/province" style="display: none; margin-top: 10px;">
                </div>
                <div class="mb-3">
                  <label for="userCity" class="form-label">City:</label>
                  <input type="text" id="cityFilter" class="form-control" placeholder="Type first 3 letters to filter..." style="margin-bottom: 8px; display: none;" oninput="filterCities()">
                  <small id="cityFilterHelp" class="form-text" style="color: #04aa6d; font-size: 11px; display: none; margin-bottom: 5px;">üí° Type first 3 characters, then select from dropdown</small>
                  <select id="userCity" class="form-control" required disabled onchange="toggleCityOther()" size="1">
                    <option value="">Select City</option>
                  </select>
                  <input type="text" id="userCityOther" class="form-control" placeholder="Enter city" style="display: none; margin-top: 10px;">
                </div>
                <div class="mb-3">
                  <label for="qrCode" class="form-label">Upload Your Social Media QR Code:</label>
                  <input type="file" id="qrCode" class="form-control" accept="image/*" required onchange="showQRPreview(this)">
                  <small class="form-text" style="color: #999;">Upload your existing social media QR code ‚Ä¢ <a href="qr-help.html" style="color: #04aa6d;">Need help?</a></small>
                  
                  <!-- QR Code Preview and Alignment -->
                  <div id="qrPreview" style="display: none; margin-top: 15px;">
                    <div id="qrContainer" style="position: relative; width: 200px; height: 200px; margin: 0 auto; border: 2px solid #04aa6d; border-radius: 8px; overflow: hidden; background: #222;">
                      <img id="qrImage" style="position: absolute; cursor: move; transition: transform 0.1s;" draggable="false">
                      <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px dashed rgba(4, 170, 109, 0.5); pointer-events: none;"></div>
                      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(4, 170, 109, 0.7); font-size: 12px; pointer-events: none;">QR CODE AREA</div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                      <button type="button" onclick="zoomQR(-0.1)" style="background: #04aa6d; color: #000; border: none; padding: 5px 10px; margin: 0 5px; border-radius: 4px; cursor: pointer;">üîç-</button>
                      <button type="button" onclick="zoomQR(0.1)" style="background: #04aa6d; color: #000; border: none; padding: 5px 10px; margin: 0 5px; border-radius: 4px; cursor: pointer;">üîç+</button>
                      <button type="button" onclick="resetQR()" style="background: #666; color: #fff; border: none; padding: 5px 10px; margin: 0 5px; border-radius: 4px; cursor: pointer;">Reset</button>
                    </div>
                    <p style="text-align: center; color: #999; font-size: 12px; margin-top: 5px;">Drag to position ‚Ä¢ Use zoom buttons to resize</p>
                  </div>
                </div>
                <button type="submit" class="mission-btn w-100">START MISCHIEF</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>



    <!-- Dashboard Section -->
    <section id="dashboard" style="display: none; padding-top: calc(80px + env(safe-area-inset-top)); scroll-margin-top: 0 !important; scroll-behavior: auto !important; position: relative; top: 0;">
      <div class="container">
        
        <!-- User Stats -->
        <div class="user-stats" id="userStats">
          <!-- Stats will be loaded here -->
        </div>

        <!-- Hashtag Instructions -->
        <div class="hashtag-instructions" style="background: rgba(4, 170, 109, 0.1); border: 1px solid #04aa6d; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
          <h3 style="color: #04aa6d; margin: 0 0 10px 0; font-size: 16px;">üì± POSTING RULE</h3>
          <p style="color: #fff; margin: 0; font-size: 14px; line-height: 1.4;">When sharing your mission photos/videos, <strong>ALWAYS include ALL hashtags</strong> from the "üì§ Share with Hashtags" button. This includes your mission hashtag, handle, points earned, and location tags. All hashtags are required for leaderboard tracking! Don't know what the hell we're talking about? Here's <a href="how-to-play.html" style="color: #04aa6d;">how to play</a>.</p>
        </div>

        <!-- Badges -->
        <div class="badges-container" id="badgesContainer">
          <!-- Badges will be loaded here -->
        </div>

        <!-- Mission Filter -->
        <div class="text-center mb-4" style="scroll-margin-top: 0 !important; position: static;">
          <button class="mission-btn" id="showAll">All Missions</button>
          <button class="mission-btn" id="showAvailable">Available</button>
          <button class="mission-btn" id="showCompleted">Completed</button>
        </div>

        <!-- Missions Container -->
        <div id="missionsContainer">
          <!-- Missions will be loaded here -->
        </div>

        <!-- Cheater Redemption Section -->
        <div class="cheater-section" style="margin-top: 50px; padding: 20px; background: rgba(255, 0, 0, 0.1); border: 2px solid #ff4444; border-radius: 8px;">
          <h3 style="color: #ff4444; text-align: center; margin-bottom: 15px;">ü§° CHEATER REDEMPTION ZONE ü§°</h3>
          <p style="color: #ccc; text-align: center; font-size: 14px; margin-bottom: 20px;">If you're scrolling down this far, you probably got caught cheating. Time to make it right, clown.</p>
          
          <div class="redemption-steps">
            <div style="background: #222; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
              <h4 style="color: #ff4444; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleCheaterMissions()">
                Step 1: Mark Cheated Missions Incomplete
                <span id="cheaterToggle" style="font-size: 12px;">‚ñº</span>
              </h4>
              <div id="cheaterMissionsList" style="max-height: 200px; overflow-y: auto; display: none;">
                <!-- Mission checkboxes will be loaded here -->
              </div>
            </div>
            
            <div style="background: #222; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
              <h4 style="color: #ff4444; margin-bottom: 10px;">Step 2: Delete Your Fake Posts</h4>
              <p style="color: #ccc; font-size: 13px;">Go delete the posts you cheated on. We'll wait.</p>
            </div>
            
            <div style="background: #222; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
              <h4 style="color: #ff4444; margin-bottom: 10px;">Step 3: Upload Clown Selfie</h4>
              <input type="file" id="clownSelfie" accept="image/*" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #ff4444; border-radius: 4px; margin-bottom: 10px;">
              <button onclick="processClownSelfie()" id="clownBtn" disabled style="background: #666; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: not-allowed; width: 100%;">ü§° ADD CLOWN OVERLAY</button>
              <p style="color: #999; font-size: 12px; margin-top: 5px;">Post with: #missionmischiefclown + your regular hashtags</p>
            </div>
            
            <div style="background: #222; padding: 15px; border-radius: 6px;">
              <h4 style="color: #ff4444; margin-bottom: 10px;">Step 4: Buy Your Bounty Hunter a Beer</h4>
              <p style="color: #ccc; font-size: 13px; margin-bottom: 10px;">Go to their Buy Me a Coffee page and buy them a beer. Screenshot the purchase. <a href="buy-me-a-coffee-help.html" style="color: #04aa6d;">Need help with payments?</a></p>
              <input type="file" id="beerProof" accept="image/*" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #ff4444; border-radius: 4px; margin-bottom: 10px;">
              <button onclick="uploadBeerProof()" id="beerBtn" disabled style="background: #666; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: not-allowed; width: 100%;">üì∏ UPLOAD BEER PROOF</button>
              <p style="color: #999; font-size: 12px; margin-top: 5px;">Post with: #missionmischiefpaidbail + screenshot</p>
            </div>
          </div>
        </div>

      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer id="footer">
    <div class="container">
      <div class="copyright">
        &copy; Copyright <strong><span>Mission Mischief</span></strong>. All Rights Reserved
      </div>
    </div>
  </footer>

  <!-- Back to top button -->
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center" id="backToTop" style="display: none;"><i class="bi bi-arrow-up-short"></i></a>
  
  <!-- Back to Dashboard Button -->
  <div id="backToDashboard" style="position: fixed; top: calc(20px + env(safe-area-inset-top)); right: 20px; z-index: 1000; display: none;">
    <button onclick="window.location.href='app.html'" style="background: #04aa6d; color: #000; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
      ‚Üê Dashboard
    </button>
  </div>

  <!-- CSS Files -->
  <link href="assets/css/overlay.css" rel="stylesheet">
  
  <!-- JS Files -->
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/missions.js"></script>
  <script src="assets/js/social.js"></script>
  <script src="assets/js/camera.js"></script>
  <script src="assets/js/print.js"></script>
  <script src="assets/js/main.js"></script>
  
  <script>
    // App initialization
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM loaded, initializing app...');
      initApp();
    });
    
    // Also force scroll on page load
    window.addEventListener('load', function() {
      window.scrollTo(0, 0);
      console.log('üîù Page fully loaded, forced scroll to top');
    });

    function initApp() {
      // Force scroll to top immediately
      window.scrollTo(0, 0);
      
      // Add small delay to ensure localStorage is fully loaded
      setTimeout(() => {
        const user = Storage.getUser();
        
        console.log('üîç App init - User state:', {
          fafoCompleted: Storage.isFAFOCompleted(),
          hasUserName: !!user.userName,
          scrollY: window.scrollY
        });
        
        // Check if FAFO (Mission 1) is completed first
        if (!Storage.isFAFOCompleted()) {
          window.location.href = 'funny-tos.html';
          return;
        }
        
        if (!user.userName) {
          showUserSetup();
        } else {
          showDashboard();
        }
      }, 100);
    }

    function showUserSetup() {
      document.getElementById('userSetup').style.display = 'block';
      
      // Force scroll to top for user setup
      window.scrollTo(0, 0);
      console.log('üîù User setup shown, scrolled to top');
      
      document.getElementById('setupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const userName = document.getElementById('userName').value.trim();
        const userHandle = document.getElementById('userHandle').value.trim();
        const userCountry = document.getElementById('userCountry').value === 'OTHER' ? 
          document.getElementById('userCountryOther').value.trim() : document.getElementById('userCountry').value;
        const userState = document.getElementById('userState').value === 'OTHER' ? 
          document.getElementById('userStateOther').value.trim() : document.getElementById('userState').value;
        const userCity = document.getElementById('userCity').value === 'OTHER' ? 
          document.getElementById('userCityOther').value.trim() : document.getElementById('userCity').value;
        const qrCodeFile = document.getElementById('qrCode').files[0];
        
        if (userName && userHandle && userCountry && userState && userCity && qrCodeFile) {
          // Use the positioned QR code data if available
          const qrImage = document.getElementById('qrImage');
          const qrData = qrImage ? qrImage.src : null;
          
          if (qrData) {
            const existingUser = Storage.getUser();
            const user = Storage.initUser(userName, userHandle);
            // Preserve FAFO completion status
            user.fafoCompleted = existingUser.fafoCompleted || false;
            user.fafoCompletedDate = existingUser.fafoCompletedDate || null;
            user.qrCodeData = qrData;
            user.country = userCountry;
            user.state = userState;
            user.city = userCity;
            Storage.saveUser(user);
            showDashboard();
          } else {
            // Fallback to original file
            const reader = new FileReader();
            reader.onload = function(e) {
              const existingUser = Storage.getUser();
              const user = Storage.initUser(userName, userHandle);
              // Preserve FAFO completion status
              user.fafoCompleted = existingUser.fafoCompleted || false;
              user.fafoCompletedDate = existingUser.fafoCompletedDate || null;
              user.qrCodeData = e.target.result;
              user.country = userCountry;
              user.state = userState;
              user.city = userCity;
              Storage.saveUser(user);
              showDashboard();
            };
            reader.readAsDataURL(qrCodeFile);
          }
        } else {
          showToast('Please fill all fields including location and upload your QR code', 'error');
        }
      });
      
      // QR Code preview and positioning
      let qrScale = 1;
      let qrX = 0;
      let qrY = 0;
      
      window.showQRPreview = function(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('qrPreview');
            const img = document.getElementById('qrImage');
            img.src = e.target.result;
            preview.style.display = 'block';
            
            // Reset positioning
            qrScale = 1;
            qrX = 0;
            qrY = 0;
            
            // Set initial size to fit container
            img.onload = function() {
              const container = document.getElementById('qrContainer');
              const containerWidth = container.offsetWidth;
              const containerHeight = container.offsetHeight;
              
              // Scale to fit container initially
              const scaleX = containerWidth / img.naturalWidth;
              const scaleY = containerHeight / img.naturalHeight;
              qrScale = Math.max(scaleX, scaleY);
              
              // Center the image
              qrX = (containerWidth - img.naturalWidth * qrScale) / 2;
              qrY = (containerHeight - img.naturalHeight * qrScale) / 2;
              
              updateQRTransform();
            };
            
            // Trigger onload if image is already cached
            if (img.complete) {
              img.onload();
            }
            
            // Make image draggable for positioning (mobile + desktop)
            let isDragging = false;
            let startX, startY;
            
            // Mouse events
            img.addEventListener('mousedown', function(e) {
              e.preventDefault();
              isDragging = true;
              startX = e.clientX;
              startY = e.clientY;
              img.style.cursor = 'grabbing';
            });
            
            // Touch events for mobile
            img.addEventListener('touchstart', function(e) {
              e.preventDefault();
              isDragging = true;
              const touch = e.touches[0];
              startX = touch.clientX;
              startY = touch.clientY;
            });
            
            document.addEventListener('mousemove', function(e) {
              if (!isDragging) return;
              e.preventDefault();
              const deltaX = e.clientX - startX;
              const deltaY = e.clientY - startY;
              qrX += deltaX;
              qrY += deltaY;
              startX = e.clientX;
              startY = e.clientY;
              updateQRTransform();
            });
            
            document.addEventListener('touchmove', function(e) {
              if (!isDragging) return;
              e.preventDefault();
              const touch = e.touches[0];
              const deltaX = touch.clientX - startX;
              const deltaY = touch.clientY - startY;
              qrX += deltaX;
              qrY += deltaY;
              startX = touch.clientX;
              startY = touch.clientY;
              updateQRTransform();
            });
            
            document.addEventListener('mouseup', function() {
              if (isDragging) {
                isDragging = false;
                img.style.cursor = 'move';
              }
            });
            
            document.addEventListener('touchend', function() {
              if (isDragging) {
                isDragging = false;
              }
            });
          };
          reader.readAsDataURL(input.files[0]);
        }
      };
      
      function updateQRTransform() {
        const img = document.getElementById('qrImage');
        if (img) {
          img.style.transform = `translate(${qrX}px, ${qrY}px) scale(${qrScale})`;
          img.style.transformOrigin = 'top left';
        }
      }
      
      window.zoomQR = function(delta) {
        qrScale = Math.max(0.1, Math.min(3, qrScale + delta));
        updateQRTransform();
      };
      
      window.resetQR = function() {
        const img = document.getElementById('qrImage');
        const container = document.getElementById('qrContainer');
        
        qrX = 0;
        qrY = 0;
        
        if (img.naturalWidth && img.naturalHeight) {
          const containerWidth = container.offsetWidth;
          const containerHeight = container.offsetHeight;
          const scaleX = containerWidth / img.naturalWidth;
          const scaleY = containerHeight / img.naturalHeight;
          qrScale = Math.max(scaleX, scaleY);
        } else {
          qrScale = 1;
        }
        
        updateQRTransform();
      };
      
      // Location data will be loaded from JSON file
      let locationData = {};
      
      // Load US states and cities from JSON file
      fetch('assets/js/usa-states-cities.json')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          console.log('Location data loaded successfully');
          // Convert to our expected format
          locationData.US = {};
          Object.entries(data).forEach(([stateCode, stateInfo]) => {
            locationData.US[stateInfo.name] = Object.keys(stateInfo.cities).sort();
          });
          console.log('States available:', Object.keys(locationData.US).length);
        })
        .catch(error => {
          console.error('Failed to load location data:', error);
          // Fallback to basic data
          locationData = {
            US: {
              'California': ['Los Angeles', 'San Francisco', 'San Diego'],
              'New York': ['New York City', 'Buffalo', 'Rochester'],
              'Texas': ['Houston', 'Dallas', 'Austin']
            }
          };
          console.log('Using fallback location data');
        });
      
      window.loadStates = function() {
        const country = document.getElementById('userCountry').value;
        const stateSelect = document.getElementById('userState');
        const stateOther = document.getElementById('userStateOther');
        const citySelect = document.getElementById('userCity');
        const cityOther = document.getElementById('userCityOther');
        
        // Reset state and city
        stateSelect.innerHTML = '<option value="">Select State/Province</option>';
        citySelect.innerHTML = '<option value="">Select City</option>';
        citySelect.disabled = true;
        stateOther.style.display = 'none';
        cityOther.style.display = 'none';
        
        if (country === 'OTHER') {
          stateSelect.disabled = true;
          stateOther.style.display = 'block';
          stateOther.required = true;
          cityOther.style.display = 'block';
          cityOther.required = true;
        } else if (country && locationData[country] && Object.keys(locationData[country]).length > 0) {
          stateSelect.disabled = false;
          stateOther.required = false;
          cityOther.required = false;
          Object.keys(locationData[country]).forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
          });
          // Add Other option
          const otherOption = document.createElement('option');
          otherOption.value = 'OTHER';
          otherOption.textContent = 'Other';
          stateSelect.appendChild(otherOption);
        } else {
          stateSelect.disabled = true;
        }
      };
      
      // Store all cities for filtering
      let allCities = [];
      
      window.loadCities = function() {
        const country = document.getElementById('userCountry').value;
        const state = document.getElementById('userState').value;
        const citySelect = document.getElementById('userCity');
        const cityFilter = document.getElementById('cityFilter');
        const cityOther = document.getElementById('userCityOther');
        
        // Reset cities
        citySelect.innerHTML = '<option value="">Select City</option>';
        cityOther.style.display = 'none';
        cityFilter.style.display = 'none';
        allCities = [];
        
        if (state === 'OTHER') {
          citySelect.disabled = true;
          cityOther.style.display = 'block';
          cityOther.required = true;
        } else if (country && state && locationData[country] && locationData[country][state]) {
          citySelect.disabled = false;
          cityOther.required = false;
          
          // Store all cities and show filter
          allCities = locationData[country][state].slice();
          cityFilter.style.display = 'block';
          document.getElementById('cityFilterHelp').style.display = 'block';
          cityFilter.value = ''; // Clear filter
          
          // Load all cities initially
          populateCities(allCities);
        } else {
          citySelect.disabled = true;
        }
      };
      
      function populateCities(cities) {
        const citySelect = document.getElementById('userCity');
        // Keep the default option
        citySelect.innerHTML = '<option value="">Select City</option>';
        
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
        
        // Add Other option
        const otherOption = document.createElement('option');
        otherOption.value = 'OTHER';
        otherOption.textContent = 'Other';
        citySelect.appendChild(otherOption);
      }
      
      window.filterCities = function() {
        const filter = document.getElementById('cityFilter').value.toLowerCase();
        if (filter === '') {
          populateCities(allCities);
        } else {
          const filtered = allCities.filter(city => 
            city.toLowerCase().includes(filter)
          );
          populateCities(filtered);
        }
      };
      
      window.toggleCountryOther = function() {
        const countrySelect = document.getElementById('userCountry');
        const countryOther = document.getElementById('userCountryOther');
        
        if (countrySelect.value === 'OTHER') {
          countryOther.style.display = 'block';
          countryOther.required = true;
        } else {
          countryOther.style.display = 'none';
          countryOther.required = false;
        }
      };
      
      window.toggleStateOther = function() {
        const stateSelect = document.getElementById('userState');
        const stateOther = document.getElementById('userStateOther');
        
        if (stateSelect.value === 'OTHER') {
          stateOther.style.display = 'block';
          stateOther.required = true;
        } else {
          stateOther.style.display = 'none';
          stateOther.required = false;
        }
      };
      
      window.toggleCityOther = function() {
        const citySelect = document.getElementById('userCity');
        const cityOther = document.getElementById('userCityOther');
        
        if (citySelect.value === 'OTHER') {
          cityOther.style.display = 'block';
          cityOther.required = true;
        } else {
          cityOther.style.display = 'none';
          cityOther.required = false;
        }
      };
    }



    function showDashboard() {
      document.getElementById('userSetup').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      
      // Show bounty hunter badge now that setup is complete
      document.getElementById('headerBadge').style.display = 'block';
      
      // Aggressive scroll management
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
      
      loadUserInfo();
      loadUserStats();
      loadBadges();
      
      // Load missions without scroll interference
      requestAnimationFrame(() => {
        loadMissions();
        setupFilters();
        loadCheaterMissions();
        
        // Final aggressive scroll reset
        setTimeout(() => {
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
          window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
          console.log('üîù Dashboard fully loaded, forced to top');
        }, 100);
      });
      
      // Initialize camera overlay
      if (window.Camera) {
        Camera.initOverlay();
      }
    }

    function loadUserInfo() {
      const user = Storage.getUser();
      document.getElementById('userInfo').textContent = `${user.userName} (${user.userHandle})`;
    }

    function loadUserStats() {
      const user = Storage.getUser();
      const available = Missions.getAvailableMissions(user);
      const badgeStates = Missions.getAllBadgeStates(user);
      const completedBadges = Object.values(badgeStates).filter(state => state !== 'locked').length;
      
      // Exclude completed setup missions from available count
      const setupMissions = [1, 2, 3, 4]; // First 4 missions are setup
      const completedSetupMissions = setupMissions.filter(id => user.completedMissions.includes(id));
      const availableCount = available.length - completedSetupMissions.length;
      
      document.getElementById('userStats').innerHTML = `
        <div class="stat-card">
          <span class="stat-number">${user.completedMissions.length}</span>
          <span class="stat-label">Completed</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${availableCount}</span>
          <span class="stat-label">Available</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${completedBadges}</span>
          <span class="stat-label">Badges</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${user.honorScore}</span>
          <span class="stat-label">Honor Score</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${user.totalPoints || 0}</span>
          <span class="stat-label">Total Points</span>
        </div>
      `;
    }

    function loadBadges() {
      const user = Storage.getUser();
      const container = document.getElementById('badgesContainer');
      
      if (!user.badges || user.badges.length === 0) {
        container.innerHTML = '<p style="color: #666;">No badges earned yet</p>';
        return;
      }
      
      container.innerHTML = user.badges.map(badge => 
        `<span class="badge">${badge.toUpperCase()}</span>`
      ).join('');
    }

    function loadMissions(filter = 'all') {
      const user = Storage.getUser();
      const scrollBefore = window.scrollY;
      console.log('Loading missions for user:', user);
      console.log('FAFO completed:', user.fafoCompleted);
      console.log('Current buy-in:', user.currentBuyIn);
      console.log('Completed buy-ins:', user.completedBuyIns);
      console.log('üìÑ Scroll position before missions:', scrollBefore);
      
      const available = Missions.getAvailableMissions(user);
      console.log('Available missions:', available.length, available.map(m => m.id));
      
      let missions = available;
      
      if (filter === 'available') {
        missions = available.filter(m => !Missions.isMissionCompleted(m.id, user));
      } else if (filter === 'completed') {
        missions = available.filter(m => Missions.isMissionCompleted(m.id, user));
      }
      
      console.log('Final missions to display:', missions.length);
      
      const container = document.getElementById('missionsContainer');
      if (missions.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No missions available. Check console for debugging info.</p>';
      } else {
        container.innerHTML = missions.map(mission => createMissionCard(mission, user)).join('');
      }
      
      // Prevent any scroll jumps from mission loading
      requestAnimationFrame(() => {
        if (window.scrollY > 50) {
          console.log('‚ö†Ô∏è Mission loading caused scroll jump, forcing back to top');
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
          window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        }
      });
    }

    function createMissionCard(mission, user) {
      const isCompleted = Missions.isMissionCompleted(mission.id, user);
      const statusClass = isCompleted ? 'completed' : '';
      const statusText = isCompleted ? 'completed' : 'available';
      const badgeState = mission.badgeId ? Missions.getBadgeState(mission.badgeId, user) : 'locked';
      const typeClass = mission.type === 'prank' ? 'prank-mission' : 'goodwill-mission';
      
      // Special handling for Mission 4 (Choose Your Destiny)
      let missionActions = '';
      if (!isCompleted) {
        if (mission.id === 4) {
          // Mission 4: Show buy-in selection buttons
          missionActions = `
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
              <button class="mission-btn" onclick="selectBuyIn('recycling')" style="background: #28a745;">üåç Green Warrior</button>
              <button class="mission-btn" onclick="selectBuyIn('cleanup')" style="background: #6c757d;">üóëÔ∏è Oscar</button>
              <button class="mission-btn" onclick="selectBuyIn('referral')" style="background: #007bff;">üéµ Bye Bye Bye</button>
              <button class="mission-btn" onclick="selectBuyIn('nothing')" style="background: #dc3545;">ü§° Do Nothing</button>
            </div>
          `;
        } else if (mission.type === 'setup') {
          missionActions = `
            <button class="mission-btn" onclick="printCard()">
              Print Card
            </button>
          `;
        } else {
          missionActions = `
            <button class="mission-btn" onclick="startMissionCapture(${mission.id})">
              üé≠ Add Overlays
            </button>
          `;
        }
        missionActions += `
          <button class="mission-btn" onclick="completeMission(${mission.id})">
            Mark Complete
          </button>
        `;
      }
      
      return `
        <div class="mission-card ${statusClass} ${typeClass}">
          <div class="mission-header" onclick="toggleMissionDetails(${mission.id})" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <div class="mission-number">${mission.id}</div>
              <div class="mission-type ${mission.type}">${mission.type.toUpperCase()}</div>
              <div class="mission-status ${statusClass}">${statusText}</div>
            </div>
            <div class="expand-icon" id="expand-${mission.id}" style="color: #04aa6d; font-size: 12px; transition: transform 0.2s;">‚ñº</div>
          </div>
          <div class="mission-title" onclick="toggleMissionDetails(${mission.id})" style="cursor: pointer;">${mission.title}</div>
          <div class="mission-location">${mission.location}</div>
          <div class="mission-description">${mission.description}</div>
          
          <div class="mission-details" id="details-${mission.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
            ${mission.badgeId && Missions.badges[mission.badgeId] ? `
              <div class="mission-badge-info" style="margin-bottom: 10px;">
                <span class="badge-name">${Missions.badges[mission.badgeId].name} Badge</span>
                <span class="badge-state ${badgeState}">${badgeState.toUpperCase()}</span>
              </div>
            ` : ''}
            ${mission.proof ? `<div class="mission-proof" style="margin-bottom: 10px; padding: 8px; background: rgba(4, 170, 109, 0.1); border-radius: 4px; font-size: 13px;"><strong>Proof:</strong> ${mission.proof}</div>` : ''}
            <div class="mission-hashtag" style="margin-bottom: 10px; font-family: monospace; color: #04aa6d; font-size: 12px;">${mission.hashtag}</div>
            <div class="mission-points" style="margin-bottom: 15px;">
              <label style="display: block; color: #04aa6d; margin-bottom: 5px; font-size: 12px; font-weight: bold;">Points Earned:</label>
              <select id="points-${mission.id}" class="points-dropdown" style="background: #333; color: #fff; border: 1px solid #04aa6d; border-radius: 4px; padding: 5px; font-size: 12px; width: 100px;" onchange="updateMissionPoints(${mission.id})">
                ${getPointsOptions(mission)}
              </select>
              <span style="color: #666; font-size: 11px; margin-left: 10px;">Default: 0 (select points earned)</span>
            </div>
            <div class="mission-actions">
              ${missionActions}
              <button class="mission-btn" onclick="shareWithHashtags(${mission.id})">
                üìã Copy Hashtags
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function setupFilters() {
      document.getElementById('showAll').addEventListener('click', () => {
        loadMissions('all');
        updateFilterButtons('showAll');
      });
      
      document.getElementById('showAvailable').addEventListener('click', () => {
        loadMissions('available');
        updateFilterButtons('showAvailable');
      });
      
      document.getElementById('showCompleted').addEventListener('click', () => {
        loadMissions('completed');
        updateFilterButtons('showCompleted');
      });
    }

    function updateFilterButtons(activeId) {
      ['showAll', 'showAvailable', 'showCompleted'].forEach(id => {
        const btn = document.getElementById(id);
        if (id === activeId) {
          btn.classList.add('completed');
        } else {
          btn.classList.remove('completed');
        }
      });
    }

    function startMissionCapture(missionId) {
      // Store mission data for badge overlay page
      const mission = Missions.getMission(missionId);
      const user = Storage.getUser();
      const hashtags = generateMissionHashtags(mission, user);
      
      // For Mission 4, determine buy-in badge
      let buyInBadge = null;
      if (missionId === 4 && user.currentBuyIn) {
        const buyInBadges = {
          'recycling': 'captain-planet-color.png',
          'cleanup': 'oscar-the-grouch-color.png', 
          'referral': 'justin-timberlake-color.png'
          // 'nothing' gets no badge
        };
        buyInBadge = buyInBadges[user.currentBuyIn] || null;
      }
      
      sessionStorage.setItem('currentMission', JSON.stringify({
        id: missionId,
        title: mission.title,
        hashtags: hashtags,
        buyInBadge: buyInBadge
      }));
      
      console.log('üé≠ Mission ${missionId} overlay - Buy-in badge:', buyInBadge);
      
      // Redirect to badge overlay page
      window.location.href = 'badge-overlay.html';
    }
    
    function showMissionCamera(missionId) {
      const mission = Missions.getMission(missionId);
      
      // Create upload modal
      const modal = document.createElement('div');
      modal.id = 'missionUploadModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      
      modal.innerHTML = `
        <div style="text-align: center; color: #04aa6d; margin-bottom: 20px;">
          <h2>Mission ${mission.id}: ${mission.title}</h2>
          <p>${mission.description}</p>
          <p><strong>Hashtag:</strong> ${mission.hashtag}</p>
        </div>
        
        <div style="background: #222; border-radius: 8px; padding: 15px; width: 100%; max-width: 500px;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; color: #04aa6d; margin-bottom: 8px; font-weight: bold; font-size: 14px;">üìÅ Upload Photo/Video:</label>
            <input type="file" id="missionFile" accept="image/*,video/*" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #04aa6d; border-radius: 4px; font-size: 14px;">
          </div>
          
          <div id="previewContainer" style="display: none; margin-bottom: 20px;">
            <div style="position: relative; background: #111; border-radius: 4px; overflow: hidden;">
              <img id="previewImage" style="width: 100%; height: auto; display: none;">
              <video id="previewVideo" controls style="width: 100%; height: auto; display: none;"></video>
              <div id="overlayPreview" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; opacity: 0; transition: opacity 0.3s;"></div>
            </div>
            <div style="text-align: center; margin-top: 10px;">
              <button onclick="toggleOverlayPreview()" id="previewToggle" style="background: #04aa6d; color: #000; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üëÅÔ∏è PREVIEW OVERLAYS</button>
            </div>
          </div>
          
          <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
            <button onclick="processUpload()" id="processBtn" disabled style="background: #666; color: #fff; padding: 8px 12px; border: none; border-radius: 4px; cursor: not-allowed; font-size: 12px; flex: 1; min-width: 120px;">üé≠ PROCESS</button>
            <button onclick="downloadResult()" id="downloadBtn" disabled style="background: #666; color: #fff; padding: 8px 12px; border: none; border-radius: 4px; cursor: not-allowed; display: none; font-size: 12px; flex: 1; min-width: 100px;">üíæ SAVE</button>
            <button onclick="shareProcessed()" id="shareBtn" disabled style="background: #666; color: #fff; padding: 8px 12px; border: none; border-radius: 4px; cursor: not-allowed; display: none; font-size: 12px; flex: 1; min-width: 100px;">üì§ SHARE</button>
            <button onclick="closeMissionUpload()" style="background: #666; color: #fff; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; flex: 1; min-width: 80px;">‚ùå CLOSE</button>
          </div>
        </div>
        
        <div style="color: #04aa6d; text-align: center; margin-top: 15px; padding: 10px; background: rgba(4, 170, 109, 0.1); border-radius: 4px; font-size: 13px; max-width: 500px;">
          <strong>üì± HOW IT WORKS:</strong><br>
          1. Take photo/video with your device camera<br>
          2. Upload it here to add Mission Mischief overlays<br>
          3. Download the result to post on social media<br>
          <span style="font-size: 11px; color: #999;">Supports photos and videos ‚Ä¢ Overlays added automatically</span>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Setup file upload handler
      document.getElementById('missionFile').addEventListener('change', handleFileUpload);
      
      // Store mission for sharing
      window.currentUploadMission = Missions.getMission(missionId);
      
      // Start camera overlay for preview
      if (window.Camera) {
        Camera.onCameraStart(missionId);
      }
    }
    
    let uploadedFile = null;
    let processedResult = null;
    
    let overlayPreviewVisible = false;
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      uploadedFile = file;
      const previewContainer = document.getElementById('previewContainer');
      const previewImage = document.getElementById('previewImage');
      const previewVideo = document.getElementById('previewVideo');
      const processBtn = document.getElementById('processBtn');
      
      // Show preview
      previewContainer.style.display = 'block';
      
      if (file.type.startsWith('image/')) {
        previewImage.style.display = 'block';
        previewVideo.style.display = 'none';
        previewImage.src = URL.createObjectURL(file);
        previewImage.onload = () => setupOverlayPreview();
      } else if (file.type.startsWith('video/')) {
        previewImage.style.display = 'none';
        previewVideo.style.display = 'block';
        previewVideo.src = URL.createObjectURL(file);
        previewVideo.onloadedmetadata = () => setupOverlayPreview();
      }
      
      // Enable process button
      processBtn.disabled = false;
      processBtn.style.background = '#04aa6d';
      processBtn.style.color = '#000';
      processBtn.style.cursor = 'pointer';
    }
    
    function setupOverlayPreview() {
      const overlayPreview = document.getElementById('overlayPreview');
      const previewContainer = overlayPreview.parentElement;
      const rect = previewContainer.getBoundingClientRect();
      
      // Create overlay elements
      overlayPreview.innerHTML = `
        <div style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; background: url('assets/images/mascot/mayhem-excited.png') center/contain no-repeat;"></div>
        <div style="position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px;">
          <div style="width: 30px; height: 30px; background: url('assets/images/badges/book-for-dummies-color.png') center/contain no-repeat; opacity: 0.9;"></div>
          <div style="width: 30px; height: 30px; background: url('assets/images/badges/coffee-color.png') center/contain no-repeat; opacity: 0.9;"></div>
        </div>
        <div style="position: absolute; top: 10px; left: 10px; background: rgba(4, 170, 109, 0.9); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">MISSION MISCHIEF</div>
      `;
    }
    
    window.toggleOverlayPreview = function() {
      const overlayPreview = document.getElementById('overlayPreview');
      const toggleBtn = document.getElementById('previewToggle');
      
      overlayPreviewVisible = !overlayPreviewVisible;
      
      if (overlayPreviewVisible) {
        overlayPreview.style.opacity = '1';
        toggleBtn.textContent = 'üôà HIDE OVERLAYS';
        toggleBtn.style.background = '#666';
      } else {
        overlayPreview.style.opacity = '0';
        toggleBtn.textContent = 'üëÅÔ∏è PREVIEW OVERLAYS';
        toggleBtn.style.background = '#04aa6d';
      }
    };
    
    window.processUpload = function() {
      if (!uploadedFile) return;
      
      const btn = document.getElementById('processBtn');
      btn.classList.add('loading');
      btn.disabled = true;
      btn.textContent = '‚è≥ PROCESSING...';
      
      setTimeout(() => {
        if (uploadedFile.type.startsWith('image/')) {
          processImage();
        } else if (uploadedFile.type.startsWith('video/')) {
          processVideo();
        }
        btn.classList.remove('loading');
        btn.textContent = 'üé≠ PROCESS WITH OVERLAYS';
      }, 1000);
    };
    
    function processImage() {
      const img = document.getElementById('previewImage');
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      
      // Draw original image
      ctx.drawImage(img, 0, 0);
      
      // Add overlays
      addOverlaysToCanvas(ctx, canvas.width, canvas.height);
      
      // Store result
      canvas.toBlob((blob) => {
        processedResult = blob;
        enableDownload('mission-photo-' + Date.now() + '.jpg');
      });
    }
    
    function processVideo() {
      // For videos, we'll create an overlay instruction
      showToast('Video processing: Use screen recording while overlays are visible', 'info');
      enableDownload('mission-video-' + Date.now() + '.mp4', true);
    }
    
    function enableDownload(filename, isVideo = false) {
      const downloadBtn = document.getElementById('downloadBtn');
      const shareBtn = document.getElementById('shareBtn');
      
      downloadBtn.disabled = false;
      downloadBtn.style.background = '#04aa6d';
      downloadBtn.style.color = '#000';
      downloadBtn.style.cursor = 'pointer';
      downloadBtn.style.display = 'inline-block';
      downloadBtn.setAttribute('data-filename', filename);
      downloadBtn.setAttribute('data-is-video', isVideo);
      
      shareBtn.disabled = false;
      shareBtn.style.background = '#04aa6d';
      shareBtn.style.color = '#000';
      shareBtn.style.cursor = 'pointer';
      shareBtn.style.display = 'inline-block';
      
      showToast('Ready to download and share!', 'success');
    }
    
    window.downloadResult = function() {
      const downloadBtn = document.getElementById('downloadBtn');
      const filename = downloadBtn.getAttribute('data-filename');
      const isVideo = downloadBtn.getAttribute('data-is-video') === 'true';
      
      if (isVideo) {
        // For videos, download original and show overlay instructions
        const url = URL.createObjectURL(uploadedFile);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Video downloaded! Add overlays using screen recording', 'info');
      } else if (processedResult) {
        // For images, download processed version
        const url = URL.createObjectURL(processedResult);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Photo with overlays downloaded!', 'success');
      }
    };
    
    function addOverlaysToCanvas(ctx, width, height) {
      const overlay = document.getElementById('badgeOverlay');
      if (!overlay) return;
      
      // Scale factors
      const scaleX = width / window.innerWidth;
      const scaleY = height / window.innerHeight;
      
      // Draw badges using existing DOM images
      const badges = overlay.querySelectorAll('.badge-item img');
      badges.forEach(badge => {
        if (badge.complete && badge.naturalWidth > 0) {
          const rect = badge.getBoundingClientRect();
          try {
            ctx.drawImage(badge, rect.left * scaleX, rect.top * scaleY, rect.width * scaleX, rect.height * scaleY);
          } catch (e) {
            console.log('Badge draw failed:', e);
          }
        }
      });
      
      // Draw mascot
      const mascot = overlay.querySelector('.mascot img');
      if (mascot && mascot.complete && mascot.naturalWidth > 0) {
        const rect = mascot.getBoundingClientRect();
        try {
          ctx.drawImage(mascot, rect.left * scaleX, rect.top * scaleY, rect.width * scaleX, rect.height * scaleY);
        } catch (e) {
          console.log('Mascot draw failed:', e);
        }
      }
      
      // Draw buy-in badge
      const buyinBadge = overlay.querySelector('.buyin-badge img');
      if (buyinBadge && buyinBadge.complete && buyinBadge.naturalWidth > 0) {
        const rect = buyinBadge.getBoundingClientRect();
        try {
          ctx.drawImage(buyinBadge, rect.left * scaleX, rect.top * scaleY, rect.width * scaleX, rect.height * scaleY);
        } catch (e) {
          console.log('Buy-in badge draw failed:', e);
        }
      }
    }
    
    window.shareProcessed = function() {
      const missionId = window.currentUploadMission?.id;
      if (!missionId) return;
      
      const mission = Missions.getMission(missionId);
      const user = Storage.getUser();
      const hashtags = generateMissionHashtags(mission, user);
      const shareText = `Just completed: ${mission.title}\n\n${hashtags}`;
      
      if (navigator.share && processedResult) {
        const file = new File([processedResult], `mission-${mission.id}.jpg`, { type: 'image/jpeg' });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            title: `Mission ${mission.id}: ${mission.title}`,
            text: shareText,
            files: [file]
          }).catch(err => {
            fallbackShare(shareText, hashtags);
          });
        } else {
          fallbackShare(shareText, hashtags);
        }
      } else {
        fallbackShare(shareText, hashtags);
      }
    };
    
    function fallbackShare(shareText, hashtags) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
          showToast('Hashtags copied! Paste when posting your photo', 'success');
        }).catch(() => {
          showToast('Manual copy: ' + hashtags, 'info');
        });
      } else {
        showToast('Manual copy: ' + hashtags, 'info');
      }
    }
    
    window.closeMissionUpload = function() {
      const modal = document.getElementById('missionUploadModal');
      if (modal) {
        modal.remove();
      }
      
      // Clean up
      uploadedFile = null;
      processedResult = null;
      window.currentUploadMission = null;
      
      // Stop camera overlay
      if (window.Camera) {
        Camera.onCameraStop();
      }
    };
    
    function completeMission(missionId) {
      const btn = event.target;
      btn.classList.add('loading');
      btn.disabled = true;
      
      setTimeout(() => {
        const user = Storage.completeMission(missionId);
        if (window.Camera) {
          Camera.onMissionComplete(missionId);
        }
        showToast('Mission completed! üéâ', 'success');
        loadUserStats();
        loadMissions();
        updateCheaterCheckbox(missionId, false); // Uncheck in cheater section
        btn.classList.remove('loading');
        btn.disabled = false;
      }, 500);
    }

    function shareWithHashtags(missionId) {
      const mission = Missions.getMission(missionId);
      const user = Storage.getUser();
      const hashtags = generateMissionHashtags(mission, user);
      
      // Copy hashtags to clipboard with toast notification
      if (navigator.clipboard) {
        navigator.clipboard.writeText(hashtags).then(() => {
          showToast('Hashtags copied! üìã Paste when posting your photo/video', 'success');
        }).catch(() => {
          showToast('Copy failed. Manual copy: ' + hashtags, 'info');
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = hashtags;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('Hashtags copied! üìã Paste when posting your photo/video', 'success');
        } catch (err) {
          showToast('Copy failed. Manual copy: ' + hashtags, 'info');
        }
        document.body.removeChild(textArea);
      }
    }
    
    function generateMissionHashtags(mission, user) {
      const baseHashtags = mission.hashtag;
      const userHashtag = `#missionmischiefuser${user.userHandle.replace('@', '')}`;
      
      // Get mission-specific points from dropdown
      const pointsDropdown = document.getElementById(`points-${mission.id}`);
      const missionPoints = pointsDropdown ? pointsDropdown.value : '0';
      const missionPointsHashtag = `#missionmischiefpoints${missionPoints}`;
      
      // Generate location hashtags for bounty hunter scraping
      let locationHashtags = '';
      if (user.country) {
        const countryClean = user.country.toLowerCase().replace(/[^a-z0-9]/g, '');
        locationHashtags += ` #missionmischiefcountry${countryClean}`;
      }
      if (user.state) {
        const stateClean = user.state.toLowerCase().replace(/[^a-z0-9]/g, '');
        locationHashtags += ` #missionmischiefstate${stateClean}`;
      }
      if (user.city) {
        const cityClean = user.city.toLowerCase().replace(/[^a-z0-9]/g, '');
        locationHashtags += ` #missionmischiefcity${cityClean}`;
      }
      
      return `${baseHashtags} ${userHashtag} ${missionPointsHashtag}${locationHashtags} #missionmischief #realworldgame`;
    }
    
    function printCard() {
      const user = Storage.getUser();
      if (user.userName && user.userHandle && user.qrCodeData) {
        PrintHandler.printCard(user);
        showToast('Card sent to printer! üñ®Ô∏è', 'success');
      } else {
        showToast('Complete your profile first!', 'error');
      }
    }

    // Toggle mission details
    window.toggleMissionDetails = function(missionId) {
      const details = document.getElementById(`details-${missionId}`);
      const icon = document.getElementById(`expand-${missionId}`);
      
      if (details.style.display === 'none') {
        details.style.display = 'block';
        icon.textContent = '‚ñ≤';
      } else {
        details.style.display = 'none';
        icon.textContent = '‚ñº';
      }
    };

    // Points dropdown generation
    function getPointsOptions(mission) {
      const points = mission.points;
      let options = '<option value="0" selected>0 (default)</option>';
      
      if (typeof points === 'number') {
        // Fixed points (1, 3, 10, etc.)
        options += `<option value="${points}">${points}</option>`;
      } else if (typeof points === 'string') {
        if (points.includes('-')) {
          // Range like "1-3" or "3-10"
          const [min, max] = points.split('-').map(p => parseInt(p.trim()));
          for (let i = min; i <= max; i++) {
            options += `<option value="${i}">${i}</option>`;
          }
        } else if (points === '?') {
          // Variable points (1-50 with scroll)
          for (let i = 1; i <= 50; i++) {
            options += `<option value="${i}">${i}</option>`;
          }
        } else if (points.includes('/')) {
          // Multiple options like "1 / 3"
          const pointValues = points.split('/').map(p => parseInt(p.trim())).filter(p => !isNaN(p));
          pointValues.forEach(p => {
            options += `<option value="${p}">${p}</option>`;
          });
        } else {
          // Try to extract numbers from string
          const matches = points.match(/\d+/g);
          if (matches) {
            matches.forEach(p => {
              options += `<option value="${p}">${p}</option>`;
            });
          }
        }
      }
      
      return options;
    }
    
    // Update mission points and store for user total
    window.updateMissionPoints = function(missionId) {
      const dropdown = document.getElementById(`points-${missionId}`);
      const points = parseInt(dropdown.value) || 0;
      
      // Store mission points in user data
      const user = Storage.getUser();
      if (!user.missionPoints) {
        user.missionPoints = {};
      }
      user.missionPoints[missionId] = points;
      
      // Update total points display
      const totalPoints = Object.values(user.missionPoints).reduce((sum, p) => sum + p, 0);
      user.totalPoints = totalPoints;
      
      Storage.saveUser(user);
      
      // Update stats display
      loadUserStats();
      
      showToast(`Mission ${missionId} points set to ${points}`, 'success');
    };
    
    // Cheater redemption functions
    function loadCheaterMissions() {
      const user = Storage.getUser();
      const container = document.getElementById('cheaterMissionsList');
      const allMissions = Missions.missionData;
      
      container.innerHTML = allMissions.map(mission => `
        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 5px; background: #333; border-radius: 4px;">
          <input type="checkbox" id="cheat-${mission.id}" onchange="toggleMissionCheat(${mission.id})" style="margin-right: 10px;">
          <label for="cheat-${mission.id}" style="color: #fff; font-size: 13px; cursor: pointer; flex: 1;">
            Mission ${mission.id}: ${mission.title}
          </label>
        </div>
      `).join('');
      
      // Setup file upload handlers
      document.getElementById('clownSelfie').addEventListener('change', function() {
        const btn = document.getElementById('clownBtn');
        if (this.files[0]) {
          btn.disabled = false;
          btn.style.background = '#ff4444';
          btn.style.cursor = 'pointer';
        }
      });
      
      
      document.getElementById('beerProof').addEventListener('change', function() {
        const btn = document.getElementById('beerBtn');
        if (this.files[0]) {
          btn.disabled = false;
          btn.style.background = '#ff4444';
          btn.style.cursor = 'pointer';
        }
      });
    }
    
    window.toggleCheaterMissions = function() {
      const list = document.getElementById('cheaterMissionsList');
      const toggle = document.getElementById('cheaterToggle');
      
      if (list.style.display === 'none') {
        list.style.display = 'block';
        toggle.textContent = '‚ñ≤';
      } else {
        list.style.display = 'none';
        toggle.textContent = '‚ñº';
      }
    };
    
    function updateCheaterCheckbox(missionId, checked) {
      const checkbox = document.getElementById(`cheat-${missionId}`);
      if (checkbox) {
        checkbox.checked = checked;
      }
    };
    
    window.toggleMissionCheat = function(missionId) {
      const checkbox = document.getElementById(`cheat-${missionId}`);
      const user = Storage.getUser();
      
      if (checkbox.checked) {
        // Mark mission as incomplete
        user.completedMissions = user.completedMissions.filter(id => id !== missionId);
        // Remove points for this mission
        if (user.missionPoints && user.missionPoints[missionId]) {
          delete user.missionPoints[missionId];
          user.totalPoints = Object.values(user.missionPoints).reduce((sum, p) => sum + p, 0);
        }
        // Deduct honor score for cheating
        user.honorScore = Math.max(0, (user.honorScore || 100) - 10);
        user.isCheater = true;
        Storage.saveUser(user);
        showToast(`Mission ${missionId} marked incomplete. Honor score deducted.`, 'success');
        loadUserStats();
        loadMissions();
      }
    };
    
    let processedClownImage = null;
    
    window.processClownSelfie = function() {
      const file = document.getElementById('clownSelfie').files[0];
      if (!file) return;
      
      const btn = document.getElementById('clownBtn');
      btn.textContent = '‚è≥ PROCESSING...';
      btn.disabled = true;
      
      // Create canvas for clown overlay
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        
        // Draw original image
        ctx.drawImage(img, 0, 0);
        
        // Add Mayhem clown overlay (bottom right)
        const mayhemClown = new Image();
        mayhemClown.onload = function() {
          const clownSize = Math.min(canvas.width, canvas.height) / 4;
          ctx.drawImage(mayhemClown, canvas.width - clownSize - 20, canvas.height - clownSize - 20, clownSize, clownSize);
          
          // Add draggable clown nose (red circle) - user can position
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2.2;
          const radius = Math.min(canvas.width, canvas.height) / 25;
          
          ctx.fillStyle = '#ff0000';
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
          ctx.fill();
          
          // Add "CLOWN" text
          ctx.fillStyle = '#ff0000';
          ctx.font = `bold ${canvas.width / 15}px Arial`;
          ctx.textAlign = 'center';
          ctx.fillText('CLOWN', centerX, canvas.height - 50);
          
          // Store processed image
          canvas.toBlob(blob => {
            processedClownImage = blob;
            
            // Update button to show options
            btn.innerHTML = '‚úÖ CLOWN READY';
            btn.disabled = false;
            btn.onclick = downloadClownSelfie;
            
            // Add share button
            const shareBtn = document.createElement('button');
            shareBtn.textContent = 'üì§ SHARE CLOWN';
            shareBtn.style.cssText = 'background: #04aa6d; color: #000; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;';
            shareBtn.onclick = shareClownSelfie;
            btn.parentNode.appendChild(shareBtn);
            
            showToast('Clown selfie ready! Download or share with #missionmischiefclown', 'success');
          });
        };
        mayhemClown.src = 'assets/images/mascot/mayhem-clown.png';
        
        // Fallback if image fails to load
        mayhemClown.onerror = function() {
          // Just add nose and text without Mayhem
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2.2;
          const radius = Math.min(canvas.width, canvas.height) / 25;
          
          ctx.fillStyle = '#ff0000';
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
          ctx.fill();
          
          ctx.fillStyle = '#ff0000';
          ctx.font = `bold ${canvas.width / 15}px Arial`;
          ctx.textAlign = 'center';
          ctx.fillText('CLOWN', centerX, canvas.height - 50);
          
          canvas.toBlob(blob => {
            processedClownImage = blob;
            btn.innerHTML = '‚úÖ CLOWN READY';
            btn.disabled = false;
            btn.onclick = downloadClownSelfie;
            
            const shareBtn = document.createElement('button');
            shareBtn.textContent = 'üì§ SHARE CLOWN';
            shareBtn.style.cssText = 'background: #04aa6d; color: #000; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;';
            shareBtn.onclick = shareClownSelfie;
            btn.parentNode.appendChild(shareBtn);
            
            showToast('Clown selfie ready!', 'success');
          });
        };
      };
      
      img.src = URL.createObjectURL(file);
    };
    
    function downloadClownSelfie() {
      if (processedClownImage) {
        const url = URL.createObjectURL(processedClownImage);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mission-mischief-clown-selfie.jpg';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Clown selfie downloaded!', 'success');
      }
    }
    
    function shareClownSelfie() {
      if (processedClownImage) {
        const file = new File([processedClownImage], 'clown-selfie.jpg', { type: 'image/jpeg' });
        const shareText = 'I got caught cheating in Mission Mischief and had to take a clown selfie! \n\n#missionmischiefclown #missionmischief #realworldgame';
        
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            title: 'Mission Mischief - Clown Selfie',
            text: shareText,
            files: [file]
          }).catch(() => {
            fallbackClownShare(shareText);
          });
        } else {
          fallbackClownShare(shareText);
        }
      }
    }
    
    function fallbackClownShare(shareText) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
          showToast('Hashtags copied! Download your clown selfie and paste when posting', 'success');
        });
      } else {
        showToast('Manual copy: #missionmischiefclown', 'info');
      }
    }
    
    let beerProofImage = null;
    
    window.uploadBeerProof = function() {
      const file = document.getElementById('beerProof').files[0];
      if (!file) return;
      
      const btn = document.getElementById('beerBtn');
      beerProofImage = file;
      
      // Update button to show options
      btn.innerHTML = '‚úÖ BEER PROOF READY';
      btn.disabled = false;
      btn.onclick = downloadBeerProof;
      
      // Add share button
      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'üì§ SHARE PROOF';
      shareBtn.style.cssText = 'background: #04aa6d; color: #000; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;';
      shareBtn.onclick = shareBeerProof;
      btn.parentNode.appendChild(shareBtn);
      
      showToast('Beer proof ready! Download or share with #missionmischiefpaidbail', 'success');
    };
    
    function downloadBeerProof() {
      if (beerProofImage) {
        const url = URL.createObjectURL(beerProofImage);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mission-mischief-beer-proof.jpg';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Beer proof downloaded!', 'success');
      }
    }
    
    function shareBeerProof() {
      if (beerProofImage) {
        const file = new File([beerProofImage], 'beer-proof.jpg', { type: 'image/jpeg' });
        const shareText = 'I paid my bounty hunter their beer money! Honor restored in Mission Mischief \n\n#missionmischiefpaidbail #missionmischief #realworldgame';
        
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            title: 'Mission Mischief - Beer Proof',
            text: shareText,
            files: [file]
          }).catch(() => {
            fallbackBeerShare(shareText);
          });
        } else {
          fallbackBeerShare(shareText);
        }
      }
    }
    
    function fallbackBeerShare(shareText) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
          showToast('Hashtags copied! Upload your beer proof and paste when posting', 'success');
        });
      } else {
        showToast('Manual copy: #missionmischiefpaidbail', 'info');
      }
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#04aa6d' : type === 'error' ? '#ff6b6b' : '#333'};
        color: ${type === 'success' ? '#000' : '#fff'};
        padding: 12px 20px;
        border-radius: 6px;
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Buy-in selection for Mission 4
    window.selectBuyIn = function(buyInId) {
      const user = Storage.getUser();
      user.currentBuyIn = buyInId;
      
      // Add to completed buy-ins if not already there
      if (!user.completedBuyIns) user.completedBuyIns = [];
      if (!user.completedBuyIns.includes(buyInId)) {
        user.completedBuyIns.push(buyInId);
      }
      
      Storage.saveUser(user);
      showToast(`Selected: ${Missions.buyIns[buyInId].title}`, 'success');
      
      // Auto-complete Mission 4
      setTimeout(() => {
        completeMission(4);
      }, 1000);
    };
    
    // Initialize app
    window.addEventListener('load', function() {
      document.body.classList.remove('page-transitioning');
    });
    
    // Back to top functionality
    window.addEventListener('scroll', function() {
      const backToTop = document.getElementById('backToTop');
      const backToDashboard = document.getElementById('backToDashboard');
      
      if (window.scrollY > 300) {
        backToTop.style.display = 'flex';
        if (backToDashboard) backToDashboard.style.display = 'block';
      } else {
        backToTop.style.display = 'none';
        if (backToDashboard) backToDashboard.style.display = 'none';
      }
    });
    
    document.getElementById('backToTop').addEventListener('click', function(e) {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>

</body>
</html>