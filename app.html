<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <!-- Mobile WebView Optimizations -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  
  <title>Mission Mischief - Dashboard</title>
  <meta content="Your Mission Mischief dashboard - track missions, badges, and honor score" name="description">
  
  <!-- Favicons -->
  <link href="assets/images/ui/favicon.png" rel="icon">
  <link href="assets/images/ui/apple-touch-icon.png" rel="apple-touch-icon">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- CSS Files -->
  <link href="assets/css/main.css" rel="stylesheet">
  <link href="assets/css/components.css" rel="stylesheet">
</head>

<body class="customBody">

  <!-- Header -->
  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="logo">
        <a href="index.html">Mission <span>Mischief</span></a>
      </div>
      <div class="user-info" id="userInfo" style="color: #04aa6d; font-weight: bold;"></div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="main">
    
    <!-- User Setup Section (shown if no user) -->
    <section id="userSetup" class="section-bg" style="display: none; padding-top: 100px;">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-6">
            <div class="mission-card">
              <h2 class="text-center mb-4">Welcome to Mission Mischief!</h2>
              <form id="setupForm">
                <div class="mb-3">
                  <label for="userName" class="form-label">Your Name:</label>
                  <input type="text" id="userName" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label for="userHandle" class="form-label">Social Media Handle:</label>
                  <input type="text" id="userHandle" class="form-control" placeholder="@username" required>
                </div>
                <div class="mb-3">
                  <label for="qrCode" class="form-label">Upload Your Social Media QR Code:</label>
                  <input type="file" id="qrCode" class="form-control" accept="image/*" required onchange="showQRPreview(this)">
                  <small class="form-text" style="color: #999;">Upload your existing social media QR code</small>
                  
                  <!-- QR Code Preview and Alignment -->
                  <div id="qrPreview" style="display: none; margin-top: 15px;">
                    <div id="qrContainer" style="position: relative; width: 200px; height: 200px; margin: 0 auto; border: 2px solid #04aa6d; border-radius: 8px; overflow: hidden; background: #222;">
                      <img id="qrImage" style="position: absolute; cursor: move; transition: transform 0.1s;" draggable="false">
                      <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 2px dashed rgba(4, 170, 109, 0.5); pointer-events: none;"></div>
                      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(4, 170, 109, 0.7); font-size: 12px; pointer-events: none;">QR CODE AREA</div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                      <button type="button" onclick="zoomQR(-0.1)" style="background: #04aa6d; color: #000; border: none; padding: 5px 10px; margin: 0 5px; border-radius: 4px; cursor: pointer;">üîç-</button>
                      <button type="button" onclick="zoomQR(0.1)" style="background: #04aa6d; color: #000; border: none; padding: 5px 10px; margin: 0 5px; border-radius: 4px; cursor: pointer;">üîç+</button>
                      <button type="button" onclick="resetQR()" style="background: #666; color: #fff; border: none; padding: 5px 10px; margin: 0 5px; border-radius: 4px; cursor: pointer;">Reset</button>
                    </div>
                    <p style="text-align: center; color: #999; font-size: 12px; margin-top: 5px;">Drag to position ‚Ä¢ Use zoom buttons to resize</p>
                  </div>
                </div>
                <button type="submit" class="mission-btn w-100">START MISCHIEF</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Buy-in Section -->
    <section id="buyinSection" style="display: none; padding-top: 100px;">
      <div class="container">
        <div class="section-title text-center">
          <h2>Choose Your Path</h2>
          <p>Select a buy-in to unlock all missions, or start with limited access</p>
        </div>
        
        <div class="row" id="buyinOptions">
          <!-- Buy-in options will be loaded here -->
        </div>
        
        <div class="text-center mt-4">
          <button id="skipBuyin" class="mission-btn">Skip - Start with Limited Access</button>
        </div>
      </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard" style="display: none; padding-top: 100px;">
      <div class="container">
        
        <!-- User Stats -->
        <div class="user-stats" id="userStats">
          <!-- Stats will be loaded here -->
        </div>

        <!-- Badges -->
        <div class="badges-container" id="badgesContainer">
          <!-- Badges will be loaded here -->
        </div>

        <!-- Mission Filter -->
        <div class="text-center mb-4">
          <button class="mission-btn" id="showAll">All Missions</button>
          <button class="mission-btn" id="showAvailable">Available</button>
          <button class="mission-btn" id="showCompleted">Completed</button>
        </div>

        <!-- Missions Container -->
        <div id="missionsContainer">
          <!-- Missions will be loaded here -->
        </div>

      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer id="footer">
    <div class="container">
      <div class="copyright">
        &copy; Copyright <strong><span>Mission Mischief</span></strong>. All Rights Reserved
      </div>
    </div>
  </footer>

  <!-- Back to top button -->
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- CSS Files -->
  <link href="assets/css/overlay.css" rel="stylesheet">
  
  <!-- JS Files -->
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/missions.js"></script>
  <script src="assets/js/social.js"></script>
  <script src="assets/js/camera.js"></script>
  <script src="assets/js/print.js"></script>
  <script src="assets/js/main.js"></script>
  
  <script>
    // App initialization
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    function initApp() {
      // Add small delay to ensure localStorage is fully loaded
      setTimeout(() => {
        const user = Storage.getUser();
        
        // Check if FAFO (Mission 1) is completed first
        if (!Storage.isFAFOCompleted()) {
          window.location.href = 'funny-tos.html';
          return;
        }
        
        if (!user.userName) {
          showUserSetup();
        } else if (!user.currentBuyIn && user.completedBuyIns.length === 0) {
          showBuyinSection();
        } else {
          showDashboard();
        }
      }, 100);
    }

    function showUserSetup() {
      document.getElementById('userSetup').style.display = 'block';
      
      document.getElementById('setupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const userName = document.getElementById('userName').value.trim();
        const userHandle = document.getElementById('userHandle').value.trim();
        const qrCodeFile = document.getElementById('qrCode').files[0];
        
        if (userName && userHandle && qrCodeFile) {
          // Use the positioned QR code data if available
          const qrImage = document.getElementById('qrImage');
          const qrData = qrImage ? qrImage.src : null;
          
          if (qrData) {
            const existingUser = Storage.getUser();
            const user = Storage.initUser(userName, userHandle);
            // Preserve FAFO completion status
            user.fafoCompleted = existingUser.fafoCompleted || false;
            user.fafoCompletedDate = existingUser.fafoCompletedDate || null;
            user.qrCodeData = qrData;
            Storage.saveUser(user);
            showBuyinSection();
          } else {
            // Fallback to original file
            const reader = new FileReader();
            reader.onload = function(e) {
              const existingUser = Storage.getUser();
              const user = Storage.initUser(userName, userHandle);
              // Preserve FAFO completion status
              user.fafoCompleted = existingUser.fafoCompleted || false;
              user.fafoCompletedDate = existingUser.fafoCompletedDate || null;
              user.qrCodeData = e.target.result;
              Storage.saveUser(user);
              showBuyinSection();
            };
            reader.readAsDataURL(qrCodeFile);
          }
        } else {
          showToast('Please fill all fields and upload your QR code', 'error');
        }
      });
      
      // QR Code preview and positioning
      let qrScale = 1;
      let qrX = 0;
      let qrY = 0;
      
      window.showQRPreview = function(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('qrPreview');
            const img = document.getElementById('qrImage');
            img.src = e.target.result;
            preview.style.display = 'block';
            
            // Reset positioning
            qrScale = 1;
            qrX = 0;
            qrY = 0;
            
            // Set initial size to fit container
            img.onload = function() {
              const container = document.getElementById('qrContainer');
              const containerWidth = container.offsetWidth;
              const containerHeight = container.offsetHeight;
              
              // Scale to fit container initially
              const scaleX = containerWidth / img.naturalWidth;
              const scaleY = containerHeight / img.naturalHeight;
              qrScale = Math.max(scaleX, scaleY);
              
              // Center the image
              qrX = (containerWidth - img.naturalWidth * qrScale) / 2;
              qrY = (containerHeight - img.naturalHeight * qrScale) / 2;
              
              updateQRTransform();
            };
            
            // Trigger onload if image is already cached
            if (img.complete) {
              img.onload();
            }
            
            // Make image draggable for positioning
            let isDragging = false;
            let startX, startY;
            
            img.addEventListener('mousedown', function(e) {
              isDragging = true;
              startX = e.clientX;
              startY = e.clientY;
              img.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', function(e) {
              if (!isDragging) return;
              const deltaX = e.clientX - startX;
              const deltaY = e.clientY - startY;
              qrX += deltaX;
              qrY += deltaY;
              startX = e.clientX;
              startY = e.clientY;
              updateQRTransform();
            });
            
            document.addEventListener('mouseup', function() {
              if (isDragging) {
                isDragging = false;
                img.style.cursor = 'move';
              }
            });
          };
          reader.readAsDataURL(input.files[0]);
        }
      };
      
      function updateQRTransform() {
        const img = document.getElementById('qrImage');
        if (img) {
          img.style.transform = `translate(${qrX}px, ${qrY}px) scale(${qrScale})`;
          img.style.transformOrigin = 'top left';
        }
      }
      
      window.zoomQR = function(delta) {
        qrScale = Math.max(0.1, Math.min(3, qrScale + delta));
        updateQRTransform();
      };
      
      window.resetQR = function() {
        const img = document.getElementById('qrImage');
        const container = document.getElementById('qrContainer');
        
        qrX = 0;
        qrY = 0;
        
        if (img.naturalWidth && img.naturalHeight) {
          const containerWidth = container.offsetWidth;
          const containerHeight = container.offsetHeight;
          const scaleX = containerWidth / img.naturalWidth;
          const scaleY = containerHeight / img.naturalHeight;
          qrScale = Math.max(scaleX, scaleY);
        } else {
          qrScale = 1;
        }
        
        updateQRTransform();
      };
    }

    function showBuyinSection() {
      document.getElementById('userSetup').style.display = 'none';
      document.getElementById('buyinSection').style.display = 'block';
      
      loadBuyinOptions();
      
      document.getElementById('skipBuyin').addEventListener('click', function() {
        showDashboard();
      });
    }

    function loadBuyinOptions() {
      const container = document.getElementById('buyinOptions');
      const user = Storage.getUser();
      const availableBuyIns = Missions.getAvailableBuyIns(user);
      const completedBuyIns = user.completedBuyIns || [];
      
      container.innerHTML = '';
      
      Object.values(availableBuyIns).forEach(buyin => {
        const isCompleted = completedBuyIns.includes(buyin.id);
        const isGoldPrompt = completedBuyIns.length === 1 && buyin.id !== 'nothing';
        
        const card = document.createElement('div');
        card.className = 'col-lg-4 mb-4';
        card.innerHTML = `
          <div class="buyin-card ${isCompleted ? 'completed' : ''} ${isGoldPrompt ? 'gold-prompt' : ''}">
            <div class="buyin-title">${buyin.title}</div>
            <div class="buyin-description">${buyin.description}</div>
            <div class="buyin-proof">Proof: ${buyin.proof}</div>
            ${!isCompleted ? `
              <button class="mission-btn" onclick="selectBuyin('${buyin.id}')">
                ${isGoldPrompt ? 'üèÜ COMPLETE FOR CROWN üèÜ' : 'Choose This Path'}
              </button>
            ` : `
              <div class="completed-badge">‚úÖ COMPLETED</div>
              <button class="mission-btn" onclick="completeBuyinProof('${buyin.id}')">
                Mark as Completed
              </button>
            `}
          </div>
        `;
        container.appendChild(card);
      });
      
      // Show crown of chaos message if eligible
      if (Missions.hasCrownOfChaos(user)) {
        const crownMessage = document.createElement('div');
        crownMessage.className = 'col-lg-12 text-center';
        crownMessage.innerHTML = `
          <div class="crown-message">
            <h2>üèÜ CROWN OF CHAOS UNLOCKED! üèÜ</h2>
            <p>You have achieved the ultimate secret level!</p>
          </div>
        `;
        container.appendChild(crownMessage);
      }
    }

    function selectBuyin(buyinId) {
      const user = Storage.getUser();
      user.currentBuyIn = buyinId;
      Storage.saveUser(user);
      showToast(`Selected ${Missions.buyIns[buyinId].title} path!`, 'success');
      showDashboard();
    }
    
    function completeBuyinProof(buyinId) {
      const user = Storage.completeBuyIn(buyinId);
      showToast(`${Missions.buyIns[buyinId].title} completed! üéâ`, 'success');
      
      // Check for crown of chaos
      if (Missions.hasCrownOfChaos(user)) {
        showToast('üèÜ CROWN OF CHAOS UNLOCKED! üèÜ', 'success');
      }
      
      loadBuyinOptions();
      if (window.Camera) {
        Camera.updateBuyInBadge();
      }
    }

    function showDashboard() {
      document.getElementById('userSetup').style.display = 'none';
      document.getElementById('buyinSection').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      
      loadUserInfo();
      loadUserStats();
      loadBadges();
      loadMissions();
      setupFilters();
      
      // Initialize camera overlay
      if (window.Camera) {
        Camera.initOverlay();
      }
    }

    function loadUserInfo() {
      const user = Storage.getUser();
      document.getElementById('userInfo').textContent = `${user.userName} (${user.userHandle})`;
    }

    function loadUserStats() {
      const user = Storage.getUser();
      const available = Missions.getAvailableMissions(user);
      const badgeStates = Missions.getAllBadgeStates(user);
      const completedBadges = Object.values(badgeStates).filter(state => state !== 'locked').length;
      
      document.getElementById('userStats').innerHTML = `
        <div class="stat-card">
          <span class="stat-number">${user.completedMissions.length}</span>
          <span class="stat-label">Completed</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${available.length}</span>
          <span class="stat-label">Available</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${completedBadges}</span>
          <span class="stat-label">Badges</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${user.honorScore}</span>
          <span class="stat-label">Honor Score</span>
        </div>
      `;
    }

    function loadBadges() {
      const user = Storage.getUser();
      const container = document.getElementById('badgesContainer');
      
      if (!user.badges || user.badges.length === 0) {
        container.innerHTML = '<p style="color: #666;">No badges earned yet</p>';
        return;
      }
      
      container.innerHTML = user.badges.map(badge => 
        `<span class="badge">${badge.toUpperCase()}</span>`
      ).join('');
    }

    function loadMissions(filter = 'all') {
      const user = Storage.getUser();
      console.log('Loading missions for user:', user);
      console.log('FAFO completed:', user.fafoCompleted);
      console.log('Current buy-in:', user.currentBuyIn);
      console.log('Completed buy-ins:', user.completedBuyIns);
      
      const available = Missions.getAvailableMissions(user);
      console.log('Available missions:', available.length, available.map(m => m.id));
      
      let missions = available;
      
      if (filter === 'available') {
        missions = available.filter(m => !Missions.isMissionCompleted(m.id, user));
      } else if (filter === 'completed') {
        missions = available.filter(m => Missions.isMissionCompleted(m.id, user));
      }
      
      console.log('Final missions to display:', missions.length);
      
      const container = document.getElementById('missionsContainer');
      if (missions.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No missions available. Check console for debugging info.</p>';
      } else {
        container.innerHTML = missions.map(mission => createMissionCard(mission, user)).join('');
      }
    }

    function createMissionCard(mission, user) {
      const isCompleted = Missions.isMissionCompleted(mission.id, user);
      const statusClass = isCompleted ? 'completed' : '';
      const statusText = isCompleted ? 'completed' : 'available';
      const badgeState = mission.badgeId ? Missions.getBadgeState(mission.badgeId, user) : 'locked';
      const typeClass = mission.type === 'prank' ? 'prank-mission' : 'goodwill-mission';
      
      return `
        <div class="mission-card ${statusClass} ${typeClass}">
          <div class="mission-header" onclick="toggleMissionDetails(${mission.id})" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <div class="mission-number">${mission.id}</div>
              <div class="mission-type ${mission.type}">${mission.type.toUpperCase()}</div>
              <div class="mission-status ${statusClass}">${statusText}</div>
            </div>
            <div class="expand-icon" id="expand-${mission.id}" style="color: #04aa6d; font-size: 12px; transition: transform 0.2s;">‚ñº</div>
          </div>
          <div class="mission-title" onclick="toggleMissionDetails(${mission.id})" style="cursor: pointer;">${mission.title}</div>
          <div class="mission-location">${mission.location}</div>
          <div class="mission-description">${mission.description}</div>
          
          <div class="mission-details" id="details-${mission.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
            ${mission.badgeId && Missions.badges[mission.badgeId] ? `
              <div class="mission-badge-info" style="margin-bottom: 10px;">
                <span class="badge-name">${Missions.badges[mission.badgeId].name} Badge</span>
                <span class="badge-state ${badgeState}">${badgeState.toUpperCase()}</span>
              </div>
            ` : ''}
            ${mission.proof ? `<div class="mission-proof" style="margin-bottom: 10px; padding: 8px; background: rgba(4, 170, 109, 0.1); border-radius: 4px; font-size: 13px;"><strong>Proof:</strong> ${mission.proof}</div>` : ''}
            <div class="mission-hashtag" style="margin-bottom: 10px; font-family: monospace; color: #04aa6d; font-size: 12px;">${mission.hashtag}</div>
            <div class="mission-actions">
              ${!isCompleted ? `
                ${mission.type === 'setup' ? `
                  <button class="mission-btn" onclick="printCard()">
                    Print Card
                  </button>
                ` : `
                  <button class="mission-btn" onclick="startMissionCapture(${mission.id})">
                    Start Mission
                  </button>
                `}
                <button class="mission-btn" onclick="completeMission(${mission.id})">
                  Mark Complete
                </button>
              ` : ''}
              <button class="mission-btn" onclick="shareMission(${mission.id})">
                Share
              </button>
              <button class="mission-btn" onclick="Social.copyHashtag('${mission.hashtag}')">
                Copy Hashtag
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function setupFilters() {
      document.getElementById('showAll').addEventListener('click', () => {
        loadMissions('all');
        updateFilterButtons('showAll');
      });
      
      document.getElementById('showAvailable').addEventListener('click', () => {
        loadMissions('available');
        updateFilterButtons('showAvailable');
      });
      
      document.getElementById('showCompleted').addEventListener('click', () => {
        loadMissions('completed');
        updateFilterButtons('showCompleted');
      });
    }

    function updateFilterButtons(activeId) {
      ['showAll', 'showAvailable', 'showCompleted'].forEach(id => {
        const btn = document.getElementById(id);
        if (id === activeId) {
          btn.classList.add('completed');
        } else {
          btn.classList.remove('completed');
        }
      });
    }

    function startMissionCapture(missionId) {
      // Show mission camera modal
      showMissionCamera(missionId);
    }
    
    function showMissionCamera(missionId) {
      const mission = Missions.getMission(missionId);
      
      // Create upload modal
      const modal = document.createElement('div');
      modal.id = 'missionUploadModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      
      modal.innerHTML = `
        <div style="text-align: center; color: #04aa6d; margin-bottom: 20px;">
          <h2>Mission ${mission.id}: ${mission.title}</h2>
          <p>${mission.description}</p>
          <p><strong>Hashtag:</strong> ${mission.hashtag}</p>
        </div>
        
        <div style="background: #222; border-radius: 8px; padding: 20px; max-width: 500px; width: 100%;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; color: #04aa6d; margin-bottom: 10px; font-weight: bold;">üìÅ Upload Your Photo/Video:</label>
            <input type="file" id="missionFile" accept="image/*,video/*" style="width: 100%; padding: 10px; background: #333; color: #fff; border: 1px solid #04aa6d; border-radius: 4px;">
          </div>
          
          <div id="previewContainer" style="display: none; margin-bottom: 20px;">
            <div style="position: relative; background: #111; border-radius: 4px; overflow: hidden;">
              <img id="previewImage" style="width: 100%; height: auto; display: none;">
              <video id="previewVideo" controls style="width: 100%; height: auto; display: none;"></video>
              <div id="overlayPreview" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; opacity: 0; transition: opacity 0.3s;"></div>
            </div>
            <div style="text-align: center; margin-top: 10px;">
              <button onclick="toggleOverlayPreview()" id="previewToggle" style="background: #04aa6d; color: #000; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üëÅÔ∏è PREVIEW OVERLAYS</button>
            </div>
          </div>
          
          <div style="text-align: center;">
            <button onclick="processUpload()" id="processBtn" disabled style="background: #666; color: #fff; padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: not-allowed;">üé≠ PROCESS WITH OVERLAYS</button>
            <button onclick="downloadResult()" id="downloadBtn" disabled style="background: #666; color: #fff; padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: not-allowed; display: none;">üíæ DOWNLOAD</button>
            <button onclick="closeMissionUpload()" style="background: #666; color: #fff; padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer;">‚ùå CLOSE</button>
          </div>
        </div>
        
        <div style="color: #04aa6d; text-align: center; margin-top: 15px; padding: 10px; background: rgba(4, 170, 109, 0.1); border-radius: 4px; font-size: 13px; max-width: 500px;">
          <strong>üì± HOW IT WORKS:</strong><br>
          1. Take photo/video with your device camera<br>
          2. Upload it here to add Mission Mischief overlays<br>
          3. Download the result to post on social media<br>
          <span style="font-size: 11px; color: #999;">Supports photos and videos ‚Ä¢ Overlays added automatically</span>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Setup file upload handler
      document.getElementById('missionFile').addEventListener('change', handleFileUpload);
      
      // Start camera overlay for preview
      if (window.Camera) {
        Camera.onCameraStart(missionId);
      }
    }
    
    let uploadedFile = null;
    let processedResult = null;
    
    let overlayPreviewVisible = false;
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      uploadedFile = file;
      const previewContainer = document.getElementById('previewContainer');
      const previewImage = document.getElementById('previewImage');
      const previewVideo = document.getElementById('previewVideo');
      const processBtn = document.getElementById('processBtn');
      
      // Show preview
      previewContainer.style.display = 'block';
      
      if (file.type.startsWith('image/')) {
        previewImage.style.display = 'block';
        previewVideo.style.display = 'none';
        previewImage.src = URL.createObjectURL(file);
        previewImage.onload = () => setupOverlayPreview();
      } else if (file.type.startsWith('video/')) {
        previewImage.style.display = 'none';
        previewVideo.style.display = 'block';
        previewVideo.src = URL.createObjectURL(file);
        previewVideo.onloadedmetadata = () => setupOverlayPreview();
      }
      
      // Enable process button
      processBtn.disabled = false;
      processBtn.style.background = '#04aa6d';
      processBtn.style.color = '#000';
      processBtn.style.cursor = 'pointer';
    }
    
    function setupOverlayPreview() {
      const overlayPreview = document.getElementById('overlayPreview');
      const previewContainer = overlayPreview.parentElement;
      const rect = previewContainer.getBoundingClientRect();
      
      // Create overlay elements
      overlayPreview.innerHTML = `
        <div style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; background: url('assets/images/mascot/mayhem-excited.png') center/contain no-repeat;"></div>
        <div style="position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px;">
          <div style="width: 30px; height: 30px; background: url('assets/images/badges/book-for-dummies-color.png') center/contain no-repeat; opacity: 0.9;"></div>
          <div style="width: 30px; height: 30px; background: url('assets/images/badges/coffee-color.png') center/contain no-repeat; opacity: 0.9;"></div>
        </div>
        <div style="position: absolute; top: 10px; left: 10px; background: rgba(4, 170, 109, 0.9); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">MISSION MISCHIEF</div>
      `;
    }
    
    window.toggleOverlayPreview = function() {
      const overlayPreview = document.getElementById('overlayPreview');
      const toggleBtn = document.getElementById('previewToggle');
      
      overlayPreviewVisible = !overlayPreviewVisible;
      
      if (overlayPreviewVisible) {
        overlayPreview.style.opacity = '1';
        toggleBtn.textContent = 'üôà HIDE OVERLAYS';
        toggleBtn.style.background = '#666';
      } else {
        overlayPreview.style.opacity = '0';
        toggleBtn.textContent = 'üëÅÔ∏è PREVIEW OVERLAYS';
        toggleBtn.style.background = '#04aa6d';
      }
    };
    
    window.processUpload = function() {
      if (!uploadedFile) return;
      
      if (uploadedFile.type.startsWith('image/')) {
        processImage();
      } else if (uploadedFile.type.startsWith('video/')) {
        processVideo();
      }
    };
    
    function processImage() {
      const img = document.getElementById('previewImage');
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      
      // Draw original image
      ctx.drawImage(img, 0, 0);
      
      // Add overlays
      addOverlaysToCanvas(ctx, canvas.width, canvas.height);
      
      // Store result
      canvas.toBlob((blob) => {
        processedResult = blob;
        enableDownload('mission-photo-' + Date.now() + '.jpg');
      });
    }
    
    function processVideo() {
      // For videos, we'll create an overlay instruction
      showToast('Video processing: Use screen recording while overlays are visible', 'info');
      enableDownload('mission-video-' + Date.now() + '.mp4', true);
    }
    
    function enableDownload(filename, isVideo = false) {
      const downloadBtn = document.getElementById('downloadBtn');
      downloadBtn.disabled = false;
      downloadBtn.style.background = '#04aa6d';
      downloadBtn.style.color = '#000';
      downloadBtn.style.cursor = 'pointer';
      downloadBtn.style.display = 'inline-block';
      downloadBtn.setAttribute('data-filename', filename);
      downloadBtn.setAttribute('data-is-video', isVideo);
      
      showToast('Ready to download!', 'success');
    }
    
    window.downloadResult = function() {
      const downloadBtn = document.getElementById('downloadBtn');
      const filename = downloadBtn.getAttribute('data-filename');
      const isVideo = downloadBtn.getAttribute('data-is-video') === 'true';
      
      if (isVideo) {
        // For videos, download original and show overlay instructions
        const url = URL.createObjectURL(uploadedFile);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Video downloaded! Add overlays using screen recording', 'info');
      } else if (processedResult) {
        // For images, download processed version
        const url = URL.createObjectURL(processedResult);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Photo with overlays downloaded!', 'success');
      }
    };
    
    function addOverlaysToCanvas(ctx, width, height) {
      const overlay = document.getElementById('badgeOverlay');
      if (!overlay) return;
      
      // Scale factors
      const scaleX = width / window.innerWidth;
      const scaleY = height / window.innerHeight;
      
      // Draw badges using existing DOM images
      const badges = overlay.querySelectorAll('.badge-item img');
      badges.forEach(badge => {
        if (badge.complete && badge.naturalWidth > 0) {
          const rect = badge.getBoundingClientRect();
          try {
            ctx.drawImage(badge, rect.left * scaleX, rect.top * scaleY, rect.width * scaleX, rect.height * scaleY);
          } catch (e) {
            console.log('Badge draw failed:', e);
          }
        }
      });
      
      // Draw mascot
      const mascot = overlay.querySelector('.mascot img');
      if (mascot && mascot.complete && mascot.naturalWidth > 0) {
        const rect = mascot.getBoundingClientRect();
        try {
          ctx.drawImage(mascot, rect.left * scaleX, rect.top * scaleY, rect.width * scaleX, rect.height * scaleY);
        } catch (e) {
          console.log('Mascot draw failed:', e);
        }
      }
      
      // Draw buy-in badge
      const buyinBadge = overlay.querySelector('.buyin-badge img');
      if (buyinBadge && buyinBadge.complete && buyinBadge.naturalWidth > 0) {
        const rect = buyinBadge.getBoundingClientRect();
        try {
          ctx.drawImage(buyinBadge, rect.left * scaleX, rect.top * scaleY, rect.width * scaleX, rect.height * scaleY);
        } catch (e) {
          console.log('Buy-in badge draw failed:', e);
        }
      }
    }
    
    window.closeMissionUpload = function() {
      const modal = document.getElementById('missionUploadModal');
      if (modal) {
        modal.remove();
      }
      
      // Clean up
      uploadedFile = null;
      processedResult = null;
      
      // Stop camera overlay
      if (window.Camera) {
        Camera.onCameraStop();
      }
    };
    
    function completeMission(missionId) {
      const user = Storage.completeMission(missionId);
      if (window.Camera) {
        Camera.onMissionComplete(missionId);
      }
      showToast('Mission completed! üéâ', 'success');
      loadUserStats();
      loadMissions();
    }

    function shareMission(missionId) {
      const mission = Missions.getMission(missionId);
      const user = Storage.getUser();
      Social.shareMissionComplete(mission, user.userHandle);
    }
    
    function printCard() {
      const user = Storage.getUser();
      if (user.userName && user.userHandle && user.qrCodeData) {
        PrintHandler.printCard(user);
        showToast('Card sent to printer! üñ®Ô∏è', 'success');
      } else {
        showToast('Complete your profile first!', 'error');
      }
    }

    // Toggle mission details
    window.toggleMissionDetails = function(missionId) {
      const details = document.getElementById(`details-${missionId}`);
      const icon = document.getElementById(`expand-${missionId}`);
      
      if (details.style.display === 'none') {
        details.style.display = 'block';
        icon.textContent = '‚ñ≤';
      } else {
        details.style.display = 'none';
        icon.textContent = '‚ñº';
      }
    };

    // Initialize app
    window.addEventListener('load', function() {
      document.body.classList.remove('page-transitioning');
    });
  </script>

</body>
</html>